<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ACNFT Verifier</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.6.0/ethers.umd.min.js"></script>
  <style>
    body { font-family: ui-sans-serif, -apple-system, "Segoe UI", Roboto, Arial; max-width: 900px; margin: 24px auto; }
    input { width: 100%; padding: 8px 10px; margin: 6px 0 14px; }
    button { padding: 10px 16px; font-weight: 600; }
    .row { display:grid; grid-template-columns: 160px 1fr; gap: 8px; align-items:center; }
    .box { background: #f4f6f8; padding: 10px 12px; border-radius: 8px; min-height: 40px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
  </style>
</head>
<body>
  <h2>ğŸ”’ ACNFT Verifier</h2>
  <p>Verify <b>ownerOf</b>, <b>tokenURI</b>, and <b>revoked</b> on localhost.</p>

  <div class="row"><label>RPC URL</label>
    <input id="rpc" value="http://127.0.0.1:8545" />
  </div>
  <div class="row"><label>Contract Address</label>
    <input id="addr" value="0x5FbDB2315678afecb367f032d93F642f64180aa3" />
  </div>
  <div class="row"><label>Token ID</label>
    <input id="tid" value="0" />
  </div>

  <button onclick="fetchAll()">Fetch</button>

  <h3>Results</h3>
  <div class="row"><div>ownerOf</div><div id="owner" class="box mono">-</div></div>
  <div class="row"><div>tokenURI</div><div id="uri" class="box mono">-</div></div>
  <div class="row"><div>revoked</div><div id="revoked" class="box mono">-</div></div>
  <div class="row"><div>Metadata (gateways)</div><div id="meta" class="box mono">-</div></div>

<script>
function $(id){ return document.getElementById(id); }

function normalizeAddress(input){
  const s = (input || "").trim();
  // 0x + 40 hex
  if (!/^0x[0-9a-fA-F]{40}$/.test(s)) throw new Error("Invalid address format");
  // è½‰å°å¯«ä¾†ç•¥é checksum æª¢æŸ¥
  return s.toLowerCase();
}

async function fetchAll(){
  try {
    const rpc = $("rpc").value.trim();
    const addrInput = $("addr").value;
    const addr = normalizeAddress(addrInput);
    const tokenId = BigInt($("tid").value.trim());

    const provider = new ethers.JsonRpcProvider(rpc);

    const abi = [
      "function ownerOf(uint256) view returns (address)",
      "function tokenURI(uint256) view returns (string)",
      "function revoked(uint256) view returns (bool)"
    ];
    const c = new ethers.Contract(addr, abi, provider);

    // æŸ¥éˆä¸Š
    const [owner, uri, revoked] = await Promise.all([
      c.ownerOf(tokenId),
      c.tokenURI(tokenId),
      c.revoked(tokenId)
    ]);

    $("owner").textContent   = owner;
    $("uri").textContent     = uri;
    $("revoked").textContent = String(revoked);

    // å˜—è©¦é€éå…¬é–‹ gateway æŠ“ metadataï¼ˆå¦‚æœæ˜¯ ipfs://ï¼‰
    $("meta").textContent = "-";
    if (uri.startsWith("ipfs://")) {
      const cid = uri.replace("ipfs://", "");
      const gateways = [
        `https://ipfs.io/ipfs/${cid}`,
        `https://cloudflare-ipfs.com/ipfs/${cid}`,
        `https://gateway.pinata.cloud/ipfs/${cid}`
      ];
      let ok = false;
      for (const u of gateways){
        try {
          const r = await fetch(u, { cache: "no-store" });
          if (r.ok){
            const j = await r.json();
            $("meta").textContent = JSON.stringify(j, null, 2);
            ok = true;
            break;
          }
        } catch {}
      }
      if (!ok) $("meta").textContent = "Failed to fetch metadata via public gateways.";
    }
  } catch (e){
    console.error(e);
    alert(e.message || String(e));
  }
}
</script>
</body>
</html>
