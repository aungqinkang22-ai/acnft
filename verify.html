<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ACNFT Verifier</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- ethers.js -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.min.js"></script>
  <!-- QRCode -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
</head>
<body class="min-h-screen bg-gray-100 p-6">
  <div class="max-w-3xl mx-auto">
    <h1 class="text-3xl font-bold mb-4">üîí ACNFT Verifier</h1>
    <p class="mb-6">Verify <code>ownerOf</code>, <code>tokenURI</code> and <code>revoked</code> on Sepolia / localhost.</p>

    <div class="grid gap-4">
      <label class="block">
        <span class="text-sm">RPC URL</span>
        <input id="rpcUrl" type="text" value="http://127.0.0.1:8545" class="w-full rounded border p-2" />
      </label>

      <label class="block">
        <span class="text-sm">Contract Address</span>
        <input id="contractAddr" type="text" class="w-full rounded border p-2" />
      </label>

      <label class="block">
        <span class="text-sm">Token ID</span>
        <input id="tokenId" type="number" value="0" class="w-full rounded border p-2" />
      </label>

      <button onclick="fetchData()" class="px-4 py-2 bg-blue-600 text-white rounded">Fetch</button>
    </div>

    <div id="results" class="mt-6 space-y-2">
      <div><strong>ownerOf:</strong> <span id="owner">-</span></div>
      <div><strong>tokenURI:</strong> <span id="tokenURI">-</span></div>
      <div><strong>revoked:</strong> <span id="revoked">-</span></div>
      <div class="mt-4">
        <strong>QR:</strong>
        <div id="qr"></div>
      </div>
      <div class="mt-4">
        <strong>Metadata (via public gateways):</strong>
        <pre id="metadata" class="bg-gray-200 p-2 text-sm overflow-x-auto"></pre>
        <div><img id="nftImage" class="mt-2 max-h-64 border" /></div>
      </div>
    </div>
  </div>

  <script>
    const abi = [
      { name: "ownerOf", type: "function", stateMutability: "view", inputs: [{ type: "uint256" }], outputs: [{ type: "address" }] },
      { name: "tokenURI", type: "function", stateMutability: "view", inputs: [{ type: "uint256" }], outputs: [{ type: "string" }] },
      { name: "revoked", type: "function", stateMutability: "view", inputs: [{ type: "uint256" }], outputs: [{ type: "bool" }] }
    ];

    async function fetchData() {
      const rpcUrl = document.getElementById("rpcUrl").value;
      const contractAddr = document.getElementById("contractAddr").value;
      const tokenId = parseInt(document.getElementById("tokenId").value);

      const provider = new ethers.JsonRpcProvider(rpcUrl);

      let owner = "-", uri = "-", revoked = "-";

      try {
        owner = await provider.call({ to: contractAddr, data: ethers.AbiCoder.defaultAbiCoder().encode(["uint256"], [tokenId]) });
      } catch {}

      try {
        const contract = new ethers.Contract(contractAddr, abi, provider);
        owner = await contract.ownerOf(tokenId);
        document.getElementById("owner").textContent = owner;

        uri = await contract.tokenURI(tokenId);
        document.getElementById("tokenURI").textContent = uri;

        revoked = await contract.revoked(tokenId);
        document.getElementById("revoked").textContent = revoked;

        // QR code
        const qrCanvas = document.createElement("canvas");
        document.getElementById("qr").innerHTML = "";
        QRCode.toCanvas(qrCanvas, `https://sepolia.etherscan.io/token/${contractAddr}?a=${tokenId}`, () => {
          document.getElementById("qr").appendChild(qrCanvas);
        });

        // fetch metadata
        if (uri.startsWith("ipfs://")) {
          const cid = uri.replace("ipfs://", "");
          const gateways = [
            `https://ipfs.io/ipfs/${cid}`,
            `https://gateway.pinata.cloud/ipfs/${cid}`,
            `https://cloudflare-ipfs.com/ipfs/${cid}`
          ];
          let metadata = null;
          for (let g of gateways) {
            try {
              const res = await fetch(g);
              if (res.ok) {
                metadata = await res.json();
                document.getElementById("metadata").textContent = JSON.stringify(metadata, null, 2);
                if (metadata.image) {
                  const imgCid = metadata.image.replace("ipfs://", "");
                  document.getElementById("nftImage").src = `https://ipfs.io/ipfs/${imgCid}`;
                }
                break;
              }
            } catch (e) {
              console.log("Gateway failed:", g);
            }
          }
          if (!metadata) document.getElementById("metadata").textContent = "‚ùå Failed to fetch metadata";
        }
      } catch (e) {
        document.getElementById("owner").textContent = "‚õî " + e.message;
        document.getElementById("tokenURI").textContent = "-";
        document.getElementById("revoked").textContent = "-";
      }
    }
  </script>
</body>
</html>
