<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ACNFT Verifier</title>
  <script src="https://cdn.jsdelivr.net/npm/viem@1.21.4/dist/index.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    label { display: block; margin-top: 1em; }
    input { width: 100%; padding: 6px; }
    button { margin-top: 1em; padding: 10px 15px; }
    .result { margin-top: 2em; padding: 1em; border: 1px solid #ccc; }
    img { max-width: 200px; margin-top: 1em; }
  </style>
</head>
<body>
  <h1>ACNFT Verifier</h1>

  <label>RPC URL</label>
  <input id="rpc" value="https://eth-sepolia.g.alchemy.com/v2/OzBtyq3IFP2qZv2Kxobrm" readonly>

  <label>Contract Address</label>
  <input id="contract" value="0xd88c83F5E503e7c7c52891b488e0Bd2507e4a20f" readonly>

  <label>Token ID</label>
  <input id="tokenId" value="0">

  <button onclick="verify()">Fetch</button>

  <div class="result">
    <p><b>Owner:</b> <span id="owner">-</span></p>
    <p><b>TokenURI:</b> <span id="tokenURI">-</span></p>
    <p><b>Revoked:</b> <span id="revoked">-</span></p>
    <div id="metadata"></div>
  </div>

  <script type="module">
    import { createPublicClient, http } from "https://esm.sh/viem@1.21.4";
    import { sepolia } from "https://esm.sh/viem@1.21.4/chains";

    const abi = [
      "function ownerOf(uint256 tokenId) view returns (address)",
      "function tokenURI(uint256 tokenId) view returns (string)",
      "function isRevoked(uint256 tokenId) view returns (bool)"
    ];

    async function verify() {
      const rpcUrl = document.getElementById('rpc').value;
      const contractAddr = document.getElementById('contract').value;
      const tokenId = parseInt(document.getElementById('tokenId').value);

      const client = createPublicClient({ chain: sepolia, transport: http(rpcUrl) });

      let owner = '-', uri = '-', revoked = '-';

      try {
        owner = await client.readContract({ address: contractAddr, abi, functionName: 'ownerOf', args: [tokenId] });
        document.getElementById('owner').textContent = owner;
      } catch (e) {
        document.getElementById('owner').textContent = '⛔ ' + (e?.shortMessage || e?.message || e);
      }

      try {
        uri = await client.readContract({ address: contractAddr, abi, functionName: 'tokenURI', args: [tokenId] });
        document.getElementById('tokenURI').textContent = uri;
      } catch (e) {
        document.getElementById('tokenURI').textContent = '⛔ ' + (e?.shortMessage || e?.message || e);
      }

      try {
        revoked = await client.readContract({ address: contractAddr, abi, functionName: 'isRevoked', args: [tokenId] });
        document.getElementById('revoked').textContent = String(revoked);
      } catch (e) {
        document.getElementById('revoked').textContent = '⛔ ' + (e?.shortMessage || e?.message || e);
      }

      // 如果有 tokenURI → 嘗試載 metadata
      if (uri.startsWith("ipfs://")) {
        const url = "https://ipfs.io/ipfs/" + uri.replace("ipfs://", "");
        try {
          const res = await fetch(url);
          const data = await res.json();
          let html = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
          if (data.image) {
            const imgUrl = data.image.startsWith("ipfs://") 
              ? "https://ipfs.io/ipfs/" + data.image.replace("ipfs://", "") 
              : data.image;
            html += `<img src="${imgUrl}">`;
          }
          document.getElementById('metadata').innerHTML = html;
        } catch (err) {
          document.getElementById('metadata').textContent = "❌ 無法載入 Metadata: " + err;
        }
      }
    }
  </script>
</body>
</html>
